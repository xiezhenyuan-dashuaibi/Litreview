import os
import re
import jieba
import jieba.posseg as pseg
from .system_service import  AI_call
import json
import time
from .core_algorithm import comprehensive_process_function
from .visualize_and_gen_outline import plot_swimlane,construct_swimlane_data,build_context_text,gen_outline
from concurrent.futures import ThreadPoolExecutor, as_completed


def extract_md_to_dict(folder_path):
    """
    è¯»å–æŒ‡å®šæ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰ .md æ–‡ä»¶ï¼Œæå–æ ‡é¢˜å’ŒæŒ‡å®šçš„å››ä¸ªæ ¸å¿ƒç« èŠ‚å†…å®¹å¹¶æ‹¼æ¥ï¼Œæ„å»ºå­—å…¸ã€‚

    å‚æ•°:
    - folder_path: str, åŒ…å«mdæ–‡ä»¶çš„æ–‡ä»¶å¤¹è·¯å¾„

    è¿”å›:
    - result_dict: dict, {æ–‡ç« æ ‡é¢˜: æ‹¼æ¥åçš„æ ¸å¿ƒç« èŠ‚å†…å®¹}
    """
    result_dict = {}

    # 1. æ£€æŸ¥æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨
    if not os.path.exists(folder_path):
        print(f"é”™è¯¯: æ–‡ä»¶å¤¹ä¸å­˜åœ¨ - {folder_path}")
        return {}

    # 2. è·å–æ‰€æœ‰ .md æ–‡ä»¶
    files = sorted([f for f in os.listdir(folder_path) if f.endswith('.md')])
    print(f"åœ¨ {folder_path} ä¸­å‘ç° {len(files)} ä¸ª Markdown æ–‡ä»¶ï¼Œå¼€å§‹å¤„ç†...")

    count_success = 0
    
    for filename in files:
        file_path = os.path.join(folder_path, filename)
        
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
                
            # --- A. æå–æ ‡é¢˜ ---
            # é€»è¾‘ï¼šåŒ¹é… "# è®ºæ–‡æ•´ç†ï¼š" æˆ– "# è®ºæ–‡æ•´ç†:" å¼€å¤´ï¼Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªæ¢è¡Œç¬¦åŠ #æˆ–è€…æ–‡ä»¶ç»“æŸ
            # re.DOTALL æ¨¡å¼ä¸‹ . å¯ä»¥åŒ¹é…æ¢è¡Œç¬¦ï¼Œä½†è¿™é‡Œæˆ‘ä»¬ç”¨éè´ªå©ªåŒ¹é… .*?
            # (?=\n#|\Z) æ˜¯æ­£å‘é¢„æŸ¥ï¼Œè¡¨ç¤ºâ€œåé¢å¿…é¡»è·Ÿç€æ¢è¡Œç¬¦+# æˆ–è€… æ–‡ä»¶ç»“æŸâ€ï¼Œä½†ä¸åŒ…å«åœ¨åŒ¹é…ç»“æœä¸­
            title_pattern = r'#\s*è®ºæ–‡æ•´ç†[ï¼š:]\s*(.*?)(?=\n#|\Z)'
            title_match = re.search(title_pattern, content, re.DOTALL)
            
            if title_match:
                # è·å–åŒ¹é…ç»„å¹¶å»é™¤é¦–å°¾ç©ºç™½
                title = title_match.group(1).strip()
            else:
                # å¦‚æœæ²¡æ‰¾åˆ°æ ‡å‡†æ ‡é¢˜æ ¼å¼ï¼Œä½¿ç”¨æ–‡ä»¶åä½œä¸ºå¤‡é€‰æ ‡é¢˜
                title = os.path.splitext(filename)[0]
                # print(f"  [è­¦å‘Š] æ–‡ä»¶ '{filename}' æœªæ‰¾åˆ°æ ‡å‡†æ ‡é¢˜æ ¼å¼ï¼Œä½¿ç”¨æ–‡ä»¶åä»£æ›¿ã€‚")

            # --- B. æå–æŒ‡å®šæ ¸å¿ƒç« èŠ‚å†…å®¹å¹¶æ‹¼æ¥ ---
            # å®šä¹‰éœ€è¦æå–çš„å›ºå®šç« èŠ‚å…³é”®è¯åˆ—è¡¨
            target_keywords = ["è®ºæ–‡ä¸»è¦å†…å®¹", "è®ºæ–‡æ ¸å¿ƒå†…å®¹æ¦‚æ‹¬", "è°±ç³»èƒŒæ™¯ä¸è„‰ç»œ", "è®¤è¯†è®ºèŒƒå¼"]
            
            extracted_parts = []
            
            for keyword in target_keywords:
                # æ„é€ æ­£åˆ™ï¼šåŒ¹é…ä»¥ ## æˆ– ### å¼€å¤´ï¼ŒåŒ…å« keyword çš„æ ‡é¢˜è¡Œ
                # åé¢è·Ÿç€å†…å®¹ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ª # å¼€å¤´çš„æ ‡é¢˜æˆ–æ–‡ä»¶æœ«å°¾
                # re.IGNORECASE å¿½ç•¥å¤§å°å†™
                # re.escape(keyword) ç¡®ä¿å…³é”®è¯ä¸­çš„ç‰¹æ®Šå­—ç¬¦è¢«è½¬ä¹‰
                pattern = r'(?:^|\n)\s*(#{1,6}\s*.*?' + re.escape(keyword) + r'.*?)\s*\n(.*?)(?=\n\s*#{1,6}|\Z)'
                
                match = re.search(pattern, content, re.DOTALL | re.IGNORECASE)
                
                if match:
                    # header = match.group(1).strip() # æ ‡é¢˜ (å¯é€‰ä¿ç•™)
                    body = match.group(2).strip()
                    if body:
                        # æ‹¼æ¥æ ¼å¼ï¼šã€ç« èŠ‚åã€‘+ æ¢è¡Œ + å†…å®¹
                        extracted_parts.append(f"ã€{keyword}ã€‘\n{body}")
            
            if extracted_parts:
                # å°†æ‰€æœ‰æ‰¾åˆ°çš„ç« èŠ‚å†…å®¹æ‹¼æ¥èµ·æ¥
                full_content = "\n\n".join(extracted_parts)
                result_dict[title] = full_content
                count_success += 1
            else:
                # å¦‚æœæ²¡æ‰¾åˆ°ä»»ä½•æ ¸å¿ƒç« èŠ‚ï¼Œè®°å½•è·³è¿‡
                # print(f"  [è·³è¿‡] æ–‡ä»¶ '{title}' ä¸­æœªæ‰¾åˆ°ä»»ä½•ç›®æ ‡æ ¸å¿ƒç« èŠ‚ã€‚")
                pass

        except Exception as e:
            print(f"  [é”™è¯¯] å¤„ç†æ–‡ä»¶ '{filename}' æ—¶å‡ºé”™: {e}")

    print(f"å¤„ç†å®Œæˆã€‚æˆåŠŸæå– {count_success} ç¯‡æ–‡ç« çš„æŒ‡å®šå†…å®¹ã€‚")
    return result_dict


def inject_labels_to_dict(docs_dict, results1, sub_results_storage):
    """
    å°†èšç±»ç»“æœä¸­çš„æ ‡ç­¾ä¿¡æ¯æ³¨å…¥åˆ°æ–‡æ¡£å­—å…¸ä¸­ã€‚
    
    å‚æ•°:
    - docs_dict: {æ ‡é¢˜: å†…å®¹å­—ç¬¦ä¸²}
    - results1: ç¬¬ä¸€è½®èšç±»ç»“æœ {æ ‡é¢˜: {'label': çˆ¶ç±»ID, ...}}
    - sub_results_storage: ç¬¬äºŒè½®èšç±»ç»“æœ {çˆ¶ç±»ID: {'results': {æ ‡é¢˜: {'label': å­ç±»ID}}}}
    
    è¿”å›:
    - enriched_docs: {æ ‡é¢˜: {'content': å†…å®¹, 'label': '0-1'}}
    """
    enriched_docs = {}
    count_labeled = 0
    
    for title, content in docs_dict.items():
        # é»˜è®¤ç»“æ„
        doc_entry = {
            'content': content,
            'label': None # å¦‚æœæ‰¾ä¸åˆ°åˆ†ç±»ï¼Œåˆ™ä¸º None
        }
        
        # 1. æŸ¥æ‰¾çˆ¶ç±» Label
        if title in results1:
            p_label = results1[title].get('label')
            
            # æ’é™¤å™ªå£°ç‚¹ (-1)
            if p_label is not None and p_label != -1:
                # 2. æŸ¥æ‰¾å­ç±» Label
                # éœ€è¦å»å¯¹åº”çš„ sub_results_storage ä¸­æŸ¥æ‰¾
                s_label = None
                if p_label in sub_results_storage:
                    sub_res = sub_results_storage[p_label].get('results', {})
                    if title in sub_res:
                        s_label = sub_res[title].get('label')
                
                # åªæœ‰å½“å­ç±»ä¹Ÿå­˜åœ¨ä¸”æœ‰æ•ˆæ—¶ï¼Œæ‰ç”Ÿæˆå®Œæ•´ Label
                if s_label is not None and s_label != -1:
                    full_label = f"{p_label}-{s_label}"
                    doc_entry['label'] = full_label
                    count_labeled += 1
        
        enriched_docs[title] = doc_entry
        
    print(f"[Labelæ³¨å…¥å®Œæˆ] å…± {len(docs_dict)} ç¯‡æ–‡ç« ï¼Œå…¶ä¸­ {count_labeled} ç¯‡æˆåŠŸåŒ¹é…åˆ° 'çˆ¶ç±»-å­ç±»' æ ‡ç­¾ã€‚")
    return enriched_docs


def gen_section_writing_plan(target_label, main_info_dict, outline_dict, outline_resp):
    """
    ä¸ºæŒ‡å®šç« èŠ‚ç”Ÿæˆè¯¦ç»†çš„æ–‡çŒ®ç»¼è¿°æ’°å†™æ€è·¯ã€‚
    
    å‚æ•°:
    - target_label: str, ç›®æ ‡ç« èŠ‚æ ‡ç­¾ (å¦‚ '0-1')
    - main_info_dict: dict, åŒ…å«æ‰€æœ‰æ–‡ç« å†…å®¹åŠæ ‡ç­¾çš„å­—å…¸
    - outline_dict: dict, å¤§çº²å­—å…¸ {label: å†™ä½œæŒ‡å¯¼}
    
    è¿”å›:
    - writing_plan: str, AI ç”Ÿæˆçš„æ’°å†™æ€è·¯
    """
    
    # 1. è·å–è¯¥ç« èŠ‚çš„å†™ä½œæŒ‡å¯¼
    writing_instruction = outline_dict.get(target_label, "ï¼ˆæœªæ‰¾åˆ°è¯¥ç« èŠ‚çš„ç‰¹å®šå†™ä½œæŒ‡å¯¼ï¼Œè¯·æ ¹æ®é€šç”¨å­¦æœ¯æ ‡å‡†æ’°å†™ï¼‰")
    
    # 2. èšåˆè¯¥ç« èŠ‚ç›¸å…³çš„æ–‡çŒ®å†…å®¹
    related_docs = []
    idx = 1
    for _, (title, info) in enumerate(main_info_dict.items(), 1):
        # info ç»“æ„: {'content': ..., 'label': ...}
        if info.get('label') == target_label:
            # æ‹¼æ¥æ ¼å¼: [åºå·] ã€Šæ ‡é¢˜ã€‹ å†…å®¹
            doc_text = f"- ã€Š{title}ã€‹\n{info['content']}"
            related_docs.append(doc_text)
            idx += 1
            
    if not related_docs:
        print(f"[Warning] æ ‡ç­¾ {target_label} ä¸‹æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ–‡çŒ®æ•°æ®ã€‚")
        docs_context = "ï¼ˆæœ¬æ¨¡å—æš‚æ— å…·ä½“å‚è€ƒæ–‡çŒ®ï¼Œè¯·åŸºäºç†è®ºæ¡†æ¶è¿›è¡Œé€»è¾‘æ¨æ¼”ï¼‰"
    else:
        docs_context = "\n\n".join(related_docs)
        print(f"[Info] æ ‡ç­¾ {target_label} èšåˆäº† {len(related_docs)} ç¯‡æ–‡çŒ®ã€‚")

    # 3. æ„å»º Prompt
    prompt = f"""# ä¸Šä¸‹æ–‡èƒŒæ™¯

## æƒ…æ™¯è§’è‰²

ä½ æ˜¯ä¸€ä½ç²¾é€šå­¦æœ¯é€»è¾‘æ„å»ºçš„**èµ„æ·±å†™ä½œè§„åˆ’å¸ˆ**ã€‚
ä½ çš„ä»»åŠ¡ä¸æ˜¯æ’°å†™æ­£æ–‡ï¼Œè€Œæ˜¯ä¸ºæ–‡çŒ®ç»¼è¿°ä¸­çš„**æŒ‡å®šç« èŠ‚**è®¾è®¡ä¸€ä»½ç²¾ç¡®åˆ°â€œè¯­ä¹‰ç»†èƒâ€çº§åˆ«çš„**è¯¦ç»†æ’°å†™è„šæœ¬ (Detailed Writing Script)**ã€‚

## æ–‡çŒ®ç»¼è¿°æ•´ä½“å¤§çº²ä»¥åŠå†™ä½œæ€è·¯

{outline_resp}

---

#ä»»åŠ¡ä¹¦

## ä½ æ‰€è´Ÿè´£çš„ç« èŠ‚ä»¥åŠè¦æ±‚

{writing_instruction}

## æ ¸å¿ƒè¦æ±‚

- åœ¨ç†è§£äº†æ–‡çŒ®ç»¼è¿°æ•´ä½“å¤§çº²èƒŒæ™¯ä¸‹ï¼Œä½ éœ€è¦é’ˆå¯¹ä½ æ‰€è´Ÿè´£çš„ç« èŠ‚ï¼Œå»é˜…è¯»æ–‡çŒ®åº“ä¸­çš„æ–‡çŒ®æ€»ç»“ï¼Œä¸ºæ–‡çŒ®ç»¼è¿°è®¾è®¡ä¸€ä»½ç²¾ç¡®åˆ°â€œè¯­ä¹‰ç»†èƒâ€çº§åˆ«çš„â€œå¯¼æ¼”è„šæœ¬â€ã€‚è¯¥â€œå¯¼æ¼”è„šæœ¬â€å…·ä½“å½¢å¼ä¸ºç”±â€œè¯­ä¹‰ç»†èƒâ€ä¸²è”ç»„æˆçš„ã€å…·æœ‰å­¦æœ¯æ•…äº‹æ€§çš„é“¾æ¡ï¼Œä½ éœ€è¦ä¸€è¾¹ç»„ç»‡é€»è¾‘å™è¿°ï¼Œä¸€è¾¹æŒ‘é€‰åˆé€‚çš„æ–‡çŒ®è¿›è¡Œå¼•ç”¨ã€‚
- ç²¾ç¡®ç†è§£â€œè¯­ä¹‰å•å…ƒ/è¯­ä¹‰ç»†èƒâ€çš„å®šä¹‰ã€‚è¯­ä¹‰å•å…ƒæ˜¯æŒ‡æ®µè½ä¸­æœ€å°çš„ã€ç‹¬ç«‹çš„ã€æœ‰æ˜ç¡®ä¸”å®Œæ•´çš„é€»è¾‘æ„ä¹‰çš„å•å…ƒï¼Œæ¯ä¸ªç»†èƒä»£è¡¨å™è¿°è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªå…·ä½“çš„æ€ç»´åŠ¨ä½œï¼ˆå¦‚ï¼šå¼•å…¥æ¦‚å¿µã€å¯¹æ¯”å·®å¼‚ã€æŒ‡å‡ºç¼ºé™·ã€å¼•ç”¨ä¾‹è¯ï¼‰ï¼Œå®ƒç±»ä¼¼äºç”µå½±ä¸­çš„ä¸€ä¸ªé•œå¤´ï¼Œå¯é•¿å¯çŸ­ï¼Œä¸€ä¸ªæ®µè½ç”±å¤šä¸ªè¯­ä¹‰å•å…ƒ/è¯­ä¹‰ç»†èƒç»„æˆï¼Œå®ƒä»¬ä¸²è”èµ·æ¥æ„æˆé€»è¾‘ç´§å¯†ä¸”è¿è´¯çš„æ–‡æ®µã€‚å†™å¥½å®ƒä»¬ï¼Œä¹Ÿå°±ä¸ºæ–‡ç« ç¼–å†™äº†æ¼”ç»è„šæœ¬ï¼Œä½ éœ€è¦åšä¸€ä¸ªç»†å¿ƒã€ä¸¥è°¨çš„å¯¼æ¼”ã€‚
- ç²¾ç¡®ç†è§£â€œå­¦æœ¯æ•…äº‹æ€§â€çš„å†…æ¶µï¼Œå­¦æœ¯è®ºæ–‡ä¸­çš„â€œè®²æ•…äº‹â€å¹¶éä½¿ç”¨æ¯”å–»ç­‰ä¿®è¾æ‰‹æ³•ç»˜å£°ç»˜è‰²åœ°æè¿°ç ”ç©¶å†…å®¹ï¼Œæ–‡çŒ®ç»¼è¿°çš„è¯­è¨€é£æ ¼ä»æ—§éœ€è¦ä¿æŒä¸¥è°¨ä¸“ä¸šï¼Œå­¦æœ¯è®ºæ–‡ä¸­çš„â€œè®²æ•…äº‹â€æ˜¯æŒ‡åœ¨æ¢³ç†æ–‡çŒ®å‘å±•è„‰ç»œæ—¶ï¼Œæ¯ä¸ªç« èŠ‚æ¨¡å—é—´éƒ½æœ‰æ¸…æ™°çš„é€»è¾‘ä»¥åŠè¯­è¨€æ‰¿æ¥ï¼Œä¾‹å¦‚ç”±Aå‘å±•åˆ°Bï¼Œæˆ–è€…Cä¸Dä¹‹é—´å…·æœ‰å¯¹æ¯”ç­‰ç­‰ã€‚ä½ æ‰€ç¼–å†™çš„è„šæœ¬éœ€è¦è®©æ–‡çŒ®ç»¼è¿°æ›´æœ‰å­¦æœ¯æ•…äº‹æ€§ï¼Œå› æ­¤åœ¨æ®µè½ä¹‹é—´ã€ç»†èƒä¹‹é—´å¿…é¡»æœ‰â€œæ¶¦æ»‘å‰‚â€ï¼ˆé€»è¾‘è¿æ¥è¯ï¼‰ã€‚ä¾‹å¦‚ï¼Œåƒè®²æ•…äº‹ä¸€æ ·ä½“ç°å‡ºâ€œå› ä¸ºAå­˜åœ¨ç¼ºé™·ï¼Œæ‰€ä»¥Bå‡ºç°äº†â€æˆ–â€œè™½ç„¶Cæ•ˆæœå¥½ï¼Œä½†Dåœ¨æ•ˆç‡ä¸Šæ›´èƒœä¸€ç­¹â€çš„æ¼”è¿›å…³ç³»ã€‚
- ä½ éœ€è¦æ˜ç™½ä½ æ­£åœ¨å†™æ–‡çŒ®ç»¼è¿°ï¼Œå› æ­¤è¯·æŒ‘é€‰æœ€åˆé€‚çš„è§†è§’æˆ–è€…çº¿ç´¢æ¥ä¸²è”æ–‡çŒ®ï¼Œ**å°½é‡å°†æ–‡çŒ®åº“ä¸­æ‰€æœ‰çš„æ–‡çŒ®éƒ½å¼•ç”¨ä¸Šï¼Œè‹¥æ–‡çŒ®åº“ä¸­æ•°é‡è¾ƒå¤šï¼Œåˆ™ä½ çš„å›å¤ä¹Ÿéœ€è¦ç›¸åº”åœ°å¢åŠ **ï¼å¦‚æœæŸç¯‡æ–‡çŒ®ä¸å½“å‰çš„é€»è¾‘é“¾æ¡å®åœ¨ä¸å…¼å®¹ï¼Œæˆ–è€…è´¨é‡è¾ƒä½ï¼Œ**è¯·æœæ–­èˆå¼ƒ**ã€‚ä¸è¦ä¸ºäº†å¼•ç”¨è€Œå¼•ç”¨ï¼Œå¼ºè¡Œæ‹¼å‡‘åªä¼šç ´åæ–‡ç« çš„æµç•…æ„Ÿã€‚
- **é¼“åŠ±ä½ åœ¨â€œå¼•ç”¨æ–‡çŒ®â€çš„è¯­ä¹‰ç»†èƒä¸­ï¼Œäº‹æ— å·¨ç»†åœ°è¯´æ˜ä»‹ç»æ¯ç¯‡æ–‡ç« æ—¶çš„ä¾§é‡ç‚¹ä¸é€»è¾‘ï¼Œè€Œå…¶ä»–å†…å®¹åˆ™ç”¨è¯­ç®€ç»ƒï¼›åœ¨â€œæ¶¦æ»‘å‰‚â€è¯­ä¹‰ç»†èƒå’Œâ€œæ ¸å¿ƒé€»è¾‘â€è¯­ä¹‰ç»†èƒä¸­ï¼Œè¯¦ç»†è¯´æ˜è¯´ç†æ€è·¯ã€‚**
- **åŒæ—¶ä¹Ÿé¼“åŠ±ä½ ç¼–å†™é•¿é•¿çš„è¯­ä¹‰ç»†èƒé“¾æ¡ï¼Œå°½é‡å°†æ–‡çŒ®åº“ä¸­çš„æ¯ä¸€ç¯‡æ–‡çŒ®éƒ½åˆç†åœ°ä¸²è”èµ·æ¥ï¼Œå¤šä½¿ç”¨æ¨ç†æ¼”ç»ã€å¯¹æ¯”åˆ†æç­‰æ–¹æ³•é…åˆé€»è¾‘è¿æ¥è¯ä¸ºæ–‡æ®µæ·»åŠ â€œè¯­ä¹‰æ¶¦æ»‘å‰‚â€ï¼Œä½¿æ–‡ç« æ›´æœ‰é€»è¾‘è¿è´¯æ„Ÿå’Œå­¦æœ¯æ•…äº‹æ€§ã€‚**

## å¯å‚è€ƒçš„å†™ä½œæ‰‹æ³•ä¸æ€è·¯

- **è§‚ç‚¹ä¸ºç‹ï¼Œç´ æä¸ºå¥´**ï¼šä¸è¦å†™æˆâ€œå¼ ä¸‰åšäº†å®éªŒAï¼Œæå››åšäº†å®éªŒBâ€ã€‚è¦é‡‡ç”¨**â€œä»¥è§‚ç‚¹ä¸ºä¸­å¿ƒï¼ˆConcept-Centricï¼‰â€**çš„å†™æ³•ï¼Œè€Œä¸æ˜¯â€œä»¥ä½œè€…/æ–‡çŒ®ä¸ºä¸­å¿ƒâ€ã€‚
- æ“ä½œæ‰‹æ³•ï¼š â€œä¸‰æ˜æ²»å™è¿°æ³•â€ï¼Œåœ¨ç»„ç»‡æ–‡çŒ®æ—¶ï¼Œå…ˆä»‹ç»è§‚ç‚¹ï¼Œå†å±•ç¤ºè¯æ®ï¼Œæœ€åè¯„ä»·ã€‚
    é¡¶å±‚ï¼ˆè§‚ç‚¹ï¼‰ï¼š â€œåœ¨éªŒè¯æ¨¡å‹é²æ£’æ€§è¿™ä¸€é—®é¢˜ä¸Šï¼Œç›®å‰çš„æ–‡çŒ®ä¸»è¦åˆ†ä¸ºç†è®ºæ¨å¯¼ä¸å®è¯å‹åŠ›æµ‹è¯•ä¸¤ç§èŒƒå¼ã€‚â€
    å¤¹å±‚ï¼ˆè¯æ®ç¾¤ï¼‰ï¼š â€œç†è®ºæ´¾ï¼ˆAuthor A, Bï¼‰å€¾å‘äºè¯æ˜...ï¼›è€Œå®è¯æ´¾ï¼ˆAuthor C, D, Eï¼‰åˆ™é€šè¿‡åœ¨å¤§è§„æ¨¡æ•°æ®é›†ä¸Šçš„æµ‹è¯•æŒ‡å‡º...â€ â€”â€” æ³¨æ„è¿™é‡ŒæŠŠå¤šç¯‡æ–‡çŒ®æ‹¬åœ¨ä¸€èµ·è¯´ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªä¸€ä¸ªè¯´ã€‚
    åº•å±‚ï¼ˆä½ çš„è¯„ä»·/Gapï¼‰ï¼š â€œå°½ç®¡å®è¯ç ”ç©¶ä¸°å¯Œï¼Œä½†ç¼ºä¹ç»Ÿä¸€çš„æµ‹è¯•æ ‡å‡†ï¼Œå¯¼è‡´ä¸¤æ´¾ç»“è®ºéš¾ä»¥ç›´æ¥å¯¹æ¯”ã€‚â€
- åœ¨ç»„ç»‡æ–‡çŒ®æ—¶ï¼Œä½ å¯ä»¥å°†æ–‡çŒ®åº“ä¸­çš„æ–‡çŒ®åˆ’åˆ†ä¸ºå¤šä¸ªâ€œä¸‰æ˜æ²»â€ï¼Œä¾æ¬¡æ¥å™è¿°ã€‚


## è¾“å‡ºæ ¼å¼è¦æ±‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ Markdown æ ¼å¼è¾“å‡ºæ’°å†™è„šæœ¬ï¼š

```EXAMPLE
## 1. æœ¬ç« å™äº‹çº¿ç´¢ (Narrative Thread)
ï¼ˆç”¨ä¸€å¥è¯æ¦‚æ‹¬æœ¬ç« è¦è®²ä¸€ä¸ªæ€æ ·çš„æ•…äº‹ã€‚ä¾‹å¦‚ï¼šâ€œæœ¬ç« å°†å±•ç¤ºè¯¥æŠ€æœ¯å¦‚ä½•ä»æ—©æœŸçš„Xå›°å¢ƒï¼Œé€šè¿‡å¼•å…¥Yæœºåˆ¶ï¼Œæœ€ç»ˆåœ¨Zåœºæ™¯å®ç°è½åœ°çš„è¿‡ç¨‹ã€‚â€ï¼‰

## 2. æ®µè½çº§è¯¦ç»†è„šæœ¬ (Paragraph-level Script)

ã€ç¬¬ä¸€æ®µï¼šå¼€ç¯‡/æ‰¿æ¥ã€‘
    [è¯­ä¹‰ç»†èƒ 1] -> [è¯­ä¹‰ç»†èƒ 2] ...
    *(ç¤ºä¾‹ï¼š[æ‰¿æ¥ä¸Šä¸€ç« å…³äº...çš„è®¨è®ºï¼ŒæŒ‡å‡ºå°½ç®¡...ä½†ä»å­˜åœ¨...ç“¶é¢ˆ/æ‰¿æ¥ï¼Œé˜è¿°æœ¬ç« èŠ‚ä¸»è¦å†…å®¹ä¸æ–‡çŒ®ç»¼è¿°æ•´ä½“å†…å®¹çš„è”ç³»ï¼Œå°†æ–‡çŒ®ç»¼è¿°çš„å…³æ³¨ç„¦ç‚¹ç§»åŠ¨è‡³æœ¬ç« ä¸»è¦å†…å®¹çš„å®šä½ä¸Šï¼Œä¸ºä¸‹æ–‡çš„è®ºè¿°åšå‡†å¤‡] -> [å¼•å‡ºæœ¬ç« çš„æ ¸å¿ƒæ¦‚å¿µ...ï¼Œå®šä¹‰å…¶åœ¨è§£å†³è¯¥ç“¶é¢ˆä¸­çš„å…³é”®ä½œç”¨] -> [ç®€è¦é¢„å‘Šæœ¬ç« å°†é‡ç‚¹è®¨è®º...å’Œ...ä¸¤ç§ä¸»æµæŠ€æœ¯è·¯çº¿])*

ã€ç¬¬äºŒæ®µï¼šæ ¸å¿ƒè®ºè¿° A (ä¾‹å¦‚ï¼šæŸæµæ´¾/æŸæ–¹æ³•)ã€‘
    [è¯­ä¹‰ç»†èƒ 1] -> [è¯­ä¹‰ç»†èƒ 2] ...
    *(ç¤ºä¾‹ï¼š[ä»å†å²ç»´åº¦å¼•å…¥è¯¥æµæ´¾çš„å¼€å±±ä¹‹ä½œã€Šæ–‡çŒ®1ã€‹ï¼Œå¼ºè°ƒå…¶æå‡ºçš„...æ€æƒ³] -> [æŒ‡å‡ºè¯¥æ€æƒ³åœ¨å¤„ç†...æƒ…å†µä¸‹çš„ä¼˜åŠ¿] -> [è½¬æŠ˜ï¼šç„¶è€Œï¼Œéšç€...çš„å¢åŠ ï¼Œè¯¥æ–¹æ³•æš´éœ²äº†...çš„ç¼ºé™·ï¼ˆå‚è€ƒã€Šæ–‡çŒ®2ã€‹çš„å®éªŒæ•°æ®ï¼‰] -> [å¼•å…¥åç»­æ”¹è¿›å·¥ä½œã€Šæ–‡çŒ®3ã€‹ï¼Œé‡ç‚¹æè¿°å…¶å¦‚ä½•é€šè¿‡...æœºåˆ¶ä¿®å¤äº†ä¸Šè¿°ç¼ºé™·])*

ã€... (æ ¹æ®é€»è¾‘éœ€è¦è®¾è®¡åç»­æ®µè½ï¼Œé€šå¸¸ 3-5 æ®µ)ã€‘
    [è¯­ä¹‰ç»†èƒ 1] -> [è¯­ä¹‰ç»†èƒ 2] ...

ã€æœ€åä¸€æ®µï¼šæ€»ç»“/è¿‡æ¸¡ã€‘
    [è¯­ä¹‰ç»†èƒ 1] -> [è¯­ä¹‰ç»†èƒ 2] ...
    *(ç¤ºä¾‹ï¼š[æ€»ç»“æœ¬ç« æ‰€è¿°æ–¹æ³•çš„å…±åŒç‰¹å¾ä¸å±€é™æ€§] -> [æŒ‡å‡ºå°½ç®¡...å–å¾—äº†è¿›æ­¥ï¼Œä½†é¢å¯¹...çš„æ–°æŒ‘æˆ˜ä¾ç„¶æ— èƒ½ä¸ºåŠ›] -> [åŸ‹ä¸‹ä¼ç¬”ï¼šè¿™è¿«ä½¿å­¦ç•Œå¯»æ‰¾æ–°çš„...ï¼ˆä¸‹ä¸€ç« çš„ä¸»é¢˜ï¼‰])*
```
**æ¯ä¸ªè¯­ä¹‰ç»†èƒä¸­ï¼Œä¸ä¸€å®šåªæœ‰ä¸€ç¯‡æ–‡ç« ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šç¯‡æ–‡ç« çš„ç»„åˆã€‚ä¾‹å¦‚æœ‰ä¸¤ç¯‡æ–‡ç« è§‚ç‚¹æœ‰è”ç³»ï¼Œåˆ™å¯åœ¨ä¸€ä¸ªè¯­ä¹‰ç»†èƒä¸­å™è¿°â€œæ–‡çŒ®ã€ŠAã€‹å’Œæ–‡çŒ®ã€ŠBã€‹å‡è¯æ˜...â€ï¼Œåˆæˆ–è€…æŸå‡ ç¯‡æ–‡çŒ®æ„æˆäº†ä¸€ä¸ªäº’è¡¥çš„ä½“ç³»æˆ–å†²çªçš„è§‚ç‚¹ï¼Œå¯åœ¨ä¸€ä¸ªè¯­ä¹‰ç»†èƒä¸­å™è¿°â€œæ–‡çŒ®ã€ŠAã€‹ã€ã€ŠBã€‹ã€ã€ŠCã€‹ç­‰åˆ†åˆ«æŒ‡å‡º...â€ã€‚**

---
# å¾…å¤„ç†æ–‡çŒ®åº“

=== æ–‡çŒ®ç´ æ ===

{docs_context[:60000]}

=== ç´ æç»“æŸ ===

---

# å…³é”®æç¤º

è¯·æ ¹æ®ä»¥ä¸Šä¸Šä¸‹æ–‡èƒŒæ™¯ã€ä»»åŠ¡ä¹¦ä»¥åŠæ–‡çŒ®åº“ï¼Œå®ŒæˆæŒ‡å®šç« èŠ‚çš„æ’°å†™è„šæœ¬ï¼Œå¹¶ä¸”æŒ‰ç…§è¾“å‡ºæ ¼å¼è¾“å‡ºã€‚
å†æ¬¡æç¤ºï¼Œä½ æ­¤æ¬¡æ‰€è´Ÿè´£çš„ç« èŠ‚ä»¥åŠè¦æ±‚æ˜¯ï¼š{writing_instruction}
è¾“å‡ºæ ¼å¼ç®€å•ç¤ºä¾‹å¦‚ä¸‹ï¼š

## 1. æœ¬ç« å™äº‹çº¿ç´¢
...æœ¬ç« èŠ‚...å°†ç”±...å¼•å…¥...å¼€å§‹...éšå³...æœ€å...

## 2. æ®µè½çº§è¯¦ç»†è„šæœ¬

ã€ç¬¬ä¸€æ®µï¼š...ã€‘
    [...] -> [...] -> [...] -> [...]...

ã€ç¬¬äºŒæ®µï¼š...ã€‘
    [é¦–å…ˆæ‰¿æ¥ä¸Šæ–‡å¹¶ä»¥...é€»è¾‘å¼•å…¥...] -> [é˜è¿°...çš„æ•´ä½“æ ¼å±€æ¦‚å†µ] -> [è‡ªç„¶å¼•å…¥å¯¹...ï¼ˆå…·ä½“æŸç¯‡æ–‡ç« çš„æ ‡é¢˜ï¼‰çš„ä»‹ç»ä¸é˜è¿°ï¼Œéœ€è¦å¼ºè°ƒ...] -> [â€œæ¶¦æ»‘å‰‚â€æè¿°ï¼ŒæŒ‡å‡ºæ–‡ç« ç¼ºä¹...ä»è€Œå¼•å…¥ä»‹ç»...] -> [è¯¦ç»†ä»‹ç»...ï¼Œçªå‡ºå¯¹æ¯”...ï¼Œä½¿ç”¨...çš„è¯æœ¯...]

ã€ç¬¬ä¸‰æ®µï¼š...ã€‘
    [...] -> [...] -> [...] -> [...]...
...

**å¼•ç”¨æ ¼å¼**ï¼šæ–‡ä¸­å¼•ç”¨æ–‡çŒ®æ—¶ï¼Œè¯·ä¸¥æ ¼ä½¿ç”¨ä¹¦åå· **ã€ŠTitleã€‹** çš„æ ¼å¼ï¼Œä¸¥è°¨ä½¿ç”¨â€œã€åºå·ã€‘â€çš„å½¢å¼å¼•ç”¨æ–‡çŒ®ã€‚
**ä½ éœ€è¦æ˜ç™½ï¼Œä½ å†™çš„æ˜¯æ–‡çŒ®ç»¼è¿°çš„è„šæœ¬ï¼Œå› æ­¤å¯¹äºæ–‡çŒ®åº“ä¸­çš„æ¯ä¸€ç¯‡æ–‡çŒ®ï¼Œä½ éƒ½éœ€è¦å°½é‡å†™è¿›ä½ çš„è„šæœ¬ä¸­ï¼é™¤éä½ è®¤ä¸ºè¿™ç¯‡æ–‡çŒ®ä¸å½“å‰ç« èŠ‚çš„ä¸»é¢˜æ— å…³ï¼Œæˆ–è€…éš¾ä»¥è¢«è¢«èå…¥ç°æœ‰é€»è¾‘ä¸­ï¼Œåˆ™å¯ä»¥èˆå»ä¸€å°éƒ¨åˆ†æ–‡çŒ®ã€‚**
**é¼“åŠ±ä½ åœ¨â€œå¼•ç”¨æ–‡çŒ®â€çš„è¯­ä¹‰ç»†èƒä¸­ï¼Œäº‹æ— å·¨ç»†åœ°è¯´æ˜ä»‹ç»æ¯ç¯‡æ–‡ç« æ—¶çš„ä¾§é‡ç‚¹ä¸é€»è¾‘ï¼Œè€Œå…¶ä»–å†…å®¹åˆ™ç”¨è¯­ç®€ç»ƒï¼›åœ¨â€œæ¶¦æ»‘å‰‚â€è¯­ä¹‰ç»†èƒå’Œâ€œæ ¸å¿ƒé€»è¾‘â€è¯­ä¹‰ç»†èƒä¸­ï¼Œè¯¦ç»†è¯´æ˜è¯´ç†æ€è·¯ã€‚**
**åŒæ—¶ä¹Ÿé¼“åŠ±ä½ ç¼–å†™é•¿é•¿çš„è¯­ä¹‰ç»†èƒé“¾æ¡ï¼Œå°½é‡å°†æ–‡çŒ®åº“ä¸­çš„æ¯ä¸€ç¯‡æ–‡çŒ®éƒ½åˆç†åœ°ä¸²è”èµ·æ¥ï¼Œå¤šä½¿ç”¨æ¨ç†æ¼”ç»ã€å¯¹æ¯”åˆ†æç­‰æ–¹æ³•é…åˆé€»è¾‘è¿æ¥è¯ä¸ºæ–‡æ®µæ·»åŠ â€œè¯­ä¹‰æ¶¦æ»‘å‰‚â€ï¼Œä½¿æ–‡ç« æ›´æœ‰é€»è¾‘è¿è´¯æ„Ÿå’Œå­¦æœ¯æ•…äº‹æ€§ã€‚**
è¯·å¼€å§‹è§„åˆ’ã€‚
"""

    # 4. è°ƒç”¨ AI
    try:
        # è·å– API é…ç½® (ç¯å¢ƒå˜é‡æˆ–é»˜è®¤å€¼)
        api_key = os.environ.get('ARK_API_KEY', '')
        model_name = os.environ.get('ARK_MODEL', 'deepseek-v3-2-251201')
        
        print(f"[AI] æ­£åœ¨ç”Ÿæˆ {target_label} çš„æ’°å†™æ€è·¯...")
        response = AI_call(prompt, api_key, model_name)
        return response
        
    except Exception as e:
        print(f"[Error] AIè°ƒç”¨å¤±è´¥: {e}")
        return None

def gen_all_section_plans(main_info_dict, outline_dict, outline_resp):
    from concurrent.futures import ThreadPoolExecutor, as_completed
    # å‡è®¾æœ‰æ•ˆæ ‡ç­¾æ ¼å¼ä¸º "æ•°å­—" æˆ– "æ•°å­—-æ•°å­—"
    valid_labels = [k for k in outline_dict.keys() if k not in ['start', 'end'] and re.match(r'^\d+-\d+$', str(k))]    
    section_plans = {}
    
    # å®šä¹‰æœ€å¤§å¹¶å‘æ•° (æ ¹æ® API é™åˆ¶è°ƒæ•´ï¼Œé€šå¸¸ 5-10 æ˜¯å®‰å…¨çš„)
    MAX_WORKERS = 5
    
    with ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
        # æäº¤æ‰€æœ‰ä»»åŠ¡
        # future_to_label: {Futureå¯¹è±¡: labelå­—ç¬¦ä¸²}
        future_to_label = {
            executor.submit(gen_section_writing_plan, label, main_info_dict, outline_dict, outline_resp): label 
            for label in valid_labels
        }
        
        # å¤„ç†ç»“æœ
        for future in as_completed(future_to_label):
            label = future_to_label[future]
            try:
                plan = future.result()
                if plan:
                    section_plans[label] = plan
                    print(f"  [å®Œæˆ] {label} æ’°å†™æ€è·¯ç”Ÿæˆå®Œæ¯•ã€‚")
                else:
                    print(f"  [å¤±è´¥] {label} ç”Ÿæˆç»“æœä¸ºç©ºã€‚")
            except Exception as exc:
                print(f"  [å¼‚å¸¸] {label} ç”Ÿæˆè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {exc}")
                
    print(f"\n[All Done] æ‰€æœ‰ç« èŠ‚æ€è·¯ç”Ÿæˆå®Œæˆï¼å…±æˆåŠŸ {len(section_plans)}/{len(valid_labels)} ä¸ªã€‚")
    return section_plans

def gen_content_section_text(target_label, section_plans, outline_resp , outline_dict, main_info_dict):
    """
    ç”Ÿæˆå…·ä½“å†…å®¹ç« èŠ‚ï¼ˆå¦‚ '0-0'ï¼‰çš„æ­£å¼æ–‡ç« ã€‚
    åŸºäºè¯¦ç»†çš„æ’°å†™æ€è·¯ (Section Plan) å’Œæ–‡çŒ®å†…å®¹ã€‚
    """
    # 1. è·å–æ’°å†™æ€è·¯
    writing_plan = section_plans.get(target_label)

    writing_instruction = outline_dict.get(target_label, "ï¼ˆæ— å…·ä½“æŒ‡å¯¼ï¼‰")

    # 2. èšåˆç›¸å…³æ–‡çŒ®
    related_docs = []
    idx = 1
    for _, (title, info) in enumerate(main_info_dict.items(), 1):
        # info ç»“æ„: {'content': ..., 'label': ...}
        if info.get('label') == target_label:
            # æ‹¼æ¥æ ¼å¼: [åºå·] ã€Šæ ‡é¢˜ã€‹ å†…å®¹
            doc_text = f"- ã€Š{title}ã€‹\n{info['content']}"
            related_docs.append(doc_text)
            idx += 1
            
    if not related_docs:
        print(f"[Warning] æ ‡ç­¾ {target_label} ä¸‹æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ–‡çŒ®æ•°æ®ã€‚")
        docs_context = "ï¼ˆæœ¬æ¨¡å—æš‚æ— å…·ä½“å‚è€ƒæ–‡çŒ®ï¼Œè¯·åŸºäºç†è®ºæ¡†æ¶è¿›è¡Œé€»è¾‘æ¨æ¼”ï¼‰"
    else:
        docs_context = "\n\n".join(related_docs)
        print(f"[Info] æ ‡ç­¾ {target_label} èšåˆäº† {len(related_docs)} ç¯‡æ–‡çŒ®ã€‚")

    # 3. æ„å»º Prompt
    prompt = f"""# ä¸Šä¸‹æ–‡èƒŒæ™¯
## æƒ…æ™¯è§’è‰²

ä½ æ˜¯ä¸€ä½**æ‰§è¡ŒåŠ›æå¼ºçš„å­¦æœ¯ç»¼è¿°æ’°ç¨¿äºº**ã€‚ä½ åˆšåˆšä»ä¸»ç¼–é‚£é‡Œé¢†åˆ°äº†**æ–‡çŒ®åº“**å’Œä¸€ä»½ç²¾ç¡®åˆ°æ®µè½é€»è¾‘çš„**â€œå¯¼æ¼”è„šæœ¬â€**ã€‚ä½ çš„ä»»åŠ¡æ˜¯ï¼š**ä¸¥æ ¼æŒ‰ç…§å¯¼æ¼”è„šæœ¬çš„ç¼–æ’ï¼Œåˆ©ç”¨å‚è€ƒæ–‡çŒ®åº“ä¸­çš„ç´ æï¼Œæ’°å†™è¯¥ç« èŠ‚çš„æ­£å¼æ­£æ–‡ã€‚**

## æ–‡çŒ®ç»¼è¿°å…¨æ–‡èƒŒæ™¯ï¼ˆäº†è§£ä¸Šä¸‹æ–‡ï¼Œé¿å…åé¢˜ï¼‰

{outline_resp}

---

# å‚è€ƒæ–‡çŒ®åº“ï¼ˆä½ çš„ç´ ææ¥æºã€‚è¯·åªä½¿ç”¨è¿™é‡Œé¢æä¾›çš„æ–‡ç« å†…å®¹ï¼Œä¸¥ç¦ç¼–é€ æ–‡çŒ®ã€‚ï¼‰

=== æ–‡çŒ®ç´ æ ===

{docs_context[:60000]}

=== ç´ æç»“æŸ ===

---

# ä»»åŠ¡ä¹¦

## ä½ æ‰€è´Ÿè´£çš„ç« èŠ‚ä»¥åŠè¦æ±‚

{writing_instruction}

## è¯¥ç« èŠ‚çš„å†™ä½œå¯¼æ¼”è„šæœ¬ï¼ˆè¿™æ˜¯ä½ å¿…é¡»ä¸¥æ ¼æ‰§è¡Œçš„è·¯çº¿å›¾ã€‚è¯·å°†è„šæœ¬ä¸­çš„æ¯ä¸€ä¸ª`[...]`è¯­ä¹‰ç»†èƒæ‰©å†™ä¸ºæµç•…çš„å­¦æœ¯è¯­è¨€ã€‚ï¼‰

{writing_plan}

## æ‰§è¡Œè¦æ±‚

- åœ¨ç†è§£äº†æ–‡çŒ®ç»¼è¿°æ•´ä½“å¤§çº²èƒŒæ™¯ä¸‹ï¼Œä½ éœ€è¦é’ˆå¯¹ä½ æ‰€è´Ÿè´£çš„ç« èŠ‚ï¼Œå»é˜…è¯»æ–‡çŒ®åº“ä¸­çš„æ–‡çŒ®æ€»ç»“ï¼Œå¹¶æœ€ç»ˆæ ¹æ®ä»¥ä¸Šç²¾ç¡®åˆ°â€œè¯­ä¹‰ç»†èƒâ€çº§åˆ«çš„â€œå¯¼æ¼”è„šæœ¬â€ï¼Œå…·æœ‰â€œå­¦æœ¯æ•…äº‹æ„Ÿâ€åœ°æ­£å¼æ’°å†™æ–‡çŒ®ç»¼è¿°ä¸­è¯¥ç« èŠ‚çš„æ­£æ–‡ã€‚
- ç²¾ç¡®ç†è§£â€œè¯­ä¹‰å•å…ƒ/è¯­ä¹‰ç»†èƒâ€çš„å®šä¹‰ã€‚è¯­ä¹‰å•å…ƒæ˜¯æŒ‡æ®µè½ä¸­æœ€å°çš„ã€ç‹¬ç«‹çš„ã€æœ‰æ˜ç¡®ä¸”å®Œæ•´çš„é€»è¾‘æ„ä¹‰çš„å•å…ƒï¼Œæ¯ä¸ªç»†èƒä»£è¡¨å™è¿°è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªå…·ä½“çš„æ€ç»´åŠ¨ä½œï¼ˆå¦‚ï¼šå¼•å…¥æ¦‚å¿µã€å¯¹æ¯”å·®å¼‚ã€æŒ‡å‡ºç¼ºé™·ã€å¼•ç”¨ä¾‹è¯ï¼‰ï¼Œå®ƒç±»ä¼¼äºç”µå½±ä¸­çš„ä¸€ä¸ªé•œå¤´ï¼Œå¯é•¿å¯çŸ­ï¼Œä¸€ä¸ªæ®µè½ç”±å¤šä¸ªè¯­ä¹‰å•å…ƒ/è¯­ä¹‰ç»†èƒç»„æˆï¼Œå®ƒä»¬ä¸²è”èµ·æ¥æ„æˆé€»è¾‘ç´§å¯†ä¸”è¿è´¯çš„æ–‡æ®µã€‚
- ç²¾ç¡®ç†è§£â€œå­¦æœ¯æ•…äº‹æ€§â€çš„å†…æ¶µï¼Œå­¦æœ¯è®ºæ–‡ä¸­çš„â€œè®²æ•…äº‹â€å¹¶éä½¿ç”¨æ¯”å–»ç­‰ä¿®è¾æ‰‹æ³•ç»˜å£°ç»˜è‰²åœ°æè¿°ç ”ç©¶å†…å®¹ï¼Œæ–‡çŒ®ç»¼è¿°çš„è¯­è¨€é£æ ¼ä»æ—§éœ€è¦ä¿æŒä¸¥è°¨ä¸“ä¸šï¼Œå­¦æœ¯è®ºæ–‡ä¸­çš„â€œè®²æ•…äº‹â€æ˜¯æŒ‡åœ¨æ¢³ç†æ–‡çŒ®å‘å±•è„‰ç»œæ—¶ï¼Œæ¯ä¸ªç« èŠ‚æ¨¡å—é—´éƒ½æœ‰æ¸…æ™°çš„é€»è¾‘ä»¥åŠè¯­è¨€æ‰¿æ¥ï¼Œä¾‹å¦‚ç”±Aå‘å±•åˆ°Bï¼Œæˆ–è€…Cä¸Dä¹‹é—´å…·æœ‰å¯¹æ¯”ç­‰ç­‰ã€‚ä½ æ‰€ç¼–å†™çš„æ–‡çŒ®ç»¼è¿°æ­£æ–‡ä¸ä»…éœ€è¦å…³æ³¨å¯¹å‚è€ƒæ–‡çŒ®çš„ä»‹ç»ï¼Œè¿˜éœ€è¦å…³æ³¨å¯¹ä¸²è”èµ·æ¯ç¯‡æ–‡çŒ®ä¹‹é—´çš„é€»è¾‘ä¸çº¿ç´¢çš„é˜è¿°ã€‚
- æ‰©å†™æ¯ä¸ªè¯­ä¹‰ç»†èƒï¼šå¯¼æ¼”è„šæœ¬ä¸­çš„æ¯ä¸€ä¸ª `[...]` éƒ½æ˜¯ä¸€ä¸ª**è¯­ä¹‰ç»†èƒ**ï¼Œä½ éœ€è¦å°†å…¶æ‰©å†™ä¸º 1-3 å¥å®Œæ•´çš„å­¦æœ¯è¡¨è¾¾ã€‚ç»†èƒä¸ç»†èƒä¹‹é—´ã€æ®µè½ä¸æ®µè½ä¹‹é—´ï¼Œéœ€è¦é€»è¾‘é€šç•…ã€‚
- æ–‡çŒ®å¼•ç”¨çš„â€œåŒé‡ä»»åŠ¡â€ï¼šå½“è„šæœ¬è¦æ±‚ä½ å¼•å…¥æŸç¯‡å…·ä½“æ–‡çŒ®ï¼ˆå¦‚ã€Šæ–‡çŒ®Xã€‹ï¼‰æ—¶ï¼Œä½ å¿…é¡»å…¼é¡¾ä¸¤ä¸ªä»»åŠ¡ï¼Œä¸€æ˜¯ä»‹ç»æ¦‚æ‹¬è¯¥æ–‡çŒ®çš„ä¸»è¦å†…å®¹ä¸å·¥ä½œï¼ŒäºŒæ˜¯åœ¨ä»‹ç»æ–‡çŒ®æ—¶è¦æ³¨é‡é€»è¾‘åµŒå…¥ï¼Œè„šæœ¬é€šå¸¸ä¼šè¦æ±‚åœ¨ä»‹ç»è¯¥æ–‡çŒ®æ˜¯éœ€è¦çªå‡ºå…¶ä¸­çš„æŸä¸ªç‚¹æˆ–å¯¹æ¯”ç‚¹ï¼Œç‰¹ä»¥æ­¤æ–‡çŒ®ä¸ºä¾‹æ¥è¯æ˜å½“å‰çš„é€»è¾‘è§‚ç‚¹ï¼Œè¿™æ˜¯ä½¿æ–‡çŒ®ç»¼è¿°é€»è¾‘é€šç•…å¹¶å…·æœ‰â€œå­¦æœ¯æ•…äº‹æ„Ÿâ€çš„é‡ç‚¹æŠ€å·§ã€‚
- **æ™ºèƒ½è¾¨åˆ«**ï¼šåœ¨å†™ä½œå¯¼æ¼”è„šæœ¬ä¸­æŸäº›è¦æ±‚å®ƒå¹¶ä¸ä¸€å®šé€‚åˆç›´æ¥å†™å‡ºæ¥ä½œä¸ºæ–‡çŒ®ç»¼è¿°çš„æ­£æ–‡ï¼Œå®ƒé€‚ç”¨äºåœ¨å™è¿°æ—¶è‡ªç„¶åœ°ä½“ç°å‡ºæ¥ï¼Œä½ è¦è°¨è®°ï¼Œä½ æ­£åœ¨å†™æ–‡çŒ®ç»¼è¿°ï¼ŒæŒ‰ç…§å†™æ–‡çŒ®ç»¼è¿°æ—¶çš„æ–‡é£ä½œå‡ºæ™ºèƒ½çš„åˆ¤æ–­å¹¶è¡Œæ–‡ã€‚
- è¡Œæ–‡è§„èŒƒï¼š
    * **å¼•ç”¨æ ¼å¼**ï¼šæ–‡ä¸­å¼•ç”¨æ–‡çŒ®æ—¶ï¼Œè¯·ä¸¥æ ¼ä½¿ç”¨ä¹¦åå· **ã€ŠTitleã€‹** çš„æ ¼å¼ï¼Œä¸¥è°¨ä½¿ç”¨â€œã€åºå·ã€‘â€çš„å½¢å¼å¼•ç”¨æ–‡çŒ®ã€‚
    * **æ®µè½ç»“æ„**ï¼šè¯·å®Œå…¨å¯¹åº”â€œå¯¼æ¼”è„šæœ¬â€ä¸­çš„æ®µè½åˆ’åˆ†ï¼Œä¸è¦éšæ„åˆå¹¶æˆ–æ‹†åˆ†æ®µè½ï¼Œæ¯ä¸ªæ®µè½ä¸­çš„å†…å®¹éœ€è¦æŒ‰ç…§â€œå†™ä½œå¯¼æ¼”è„šæœ¬â€ä¸­çš„è¯­ä¹‰ç»†èƒé“¾è¿›è¡Œç»„ç»‡ã€‚
    * **å­¦æœ¯è¯­æ°”**ï¼šä¿æŒå®¢è§‚ã€ä¸¥è°¨ã€é€»è¾‘æ€§å¼ºï¼Œé¿å…å£è¯­åŒ–ï¼›ä¸¥ç¦åœ¨æ­£æ–‡ä¸­ä½¿ç”¨â€œâ†’â€ç­‰ä¸ç¬¦åˆå­¦æœ¯è§„èŒƒçš„ç¬¦å·ï¼›ä¸¥ç¦åœ¨æ–‡ä¸­ä½¿ç”¨â€œæˆ‘â€ç­‰ä¸»è§‚è¯­è¨€ï¼Œè€Œè¦ä½¿ç”¨â€œæœ¬ç ”ç©¶â€ã€â€œæœ¬æ–‡â€ç­‰å®¢è§‚è¯­è¨€ã€‚
    * **æ ‡é¢˜è¦æ±‚**ï¼šç”Ÿæˆæ—¶éœ€è¦è¿åŒæ ‡é¢˜ä»¥åŠåºå·ä¸€èµ·ç”Ÿæˆï¼Œå¦‚â€œ1. ...â€ã€â€œ2.1. ...â€ç­‰ã€‚
    * **æ®µè½è¦æ±‚**ï¼šæ­£å¸¸ç”Ÿæˆæ¯ä¸ªæ®µè½å³å¯ï¼Œä¸å¿…å¦‚å†™ä½œè„šæœ¬ä¸€èˆ¬æ ‡æ³¨æ®µè½åºå·ã€‚

---

è¯·å¼€å§‹æ’°å†™æ­£æ–‡ï¼š
"""
    try:
        api_key = os.environ.get('ARK_API_KEY', '')
        model_name = os.environ.get('ARK_MODEL', 'deepseek-v3-2-251201')
        print(f"[AI] æ­£åœ¨æ’°å†™å†…å®¹ç« èŠ‚ {target_label} ...")
        return AI_call(prompt, api_key, model_name)
    except Exception as e:
        print(f"[Error] {target_label} æ’°å†™å¤±è´¥: {e}")
        return None


def gen_side_section_text(target_label, outline_dict, outline_resp):
    """
    ç”Ÿæˆå®è§‚/è¿‡æ¸¡ç« èŠ‚ï¼ˆå¦‚ 'start', 'end', '0'ï¼‰çš„æ­£å¼æ–‡ç« ã€‚
    ä¾§é‡äºç»Ÿé¢†å…¨æ–‡ã€èƒŒæ™¯ä»‹ç»æˆ–æ€»ç»“å±•æœ›ã€‚
    """
    # 1. è·å–è¯¥ç« èŠ‚çš„å¤§çº²æŒ‡å¯¼
    instruction = outline_dict.get(target_label, "")

    instruction_txt = (instruction or "").strip()
    if (not instruction_txt) or (len(instruction_txt) > 700):
        if target_label == 'start':
            instruction = "ä½ å°†è´Ÿè´£æ–‡çŒ®ç»¼è¿°çš„å¼€ç¯‡å°èŠ‚ï¼Œä¹Ÿå³ç¬¬ä¸€ä¸ªäºŒçº§æ ‡é¢˜ä¹‹å‰çš„å†…å®¹ï¼Œè¯·æŒ‰ç…§å‰è¿°è¦æ±‚ï¼Œä¸ºæ•´ç¯‡æ–‡çŒ®ç»¼è¿°å†™ä½œæ€»é¢†å°èŠ‚ï¼Œæ¸…æ™°åœ°ä»‹ç»è¯¥é¢†åŸŸçš„å¤§è‡´çŠ¶å†µä»¥åŠè‡ªç„¶è¿‡æ¸¡åˆ°é˜è¿°æœ¬æ–‡æ‰“ç®—ä»¥æ€æ ·çš„é€»è¾‘çº¿ç´¢æ¥è®²è¿°è¯¥é¢†åŸŸçš„å‘å±•ã€‚"
        elif target_label == 'end':
            instruction = "ä½ å°†è´Ÿè´£æ–‡çŒ®ç»¼è¿°çš„ç»“å°¾å°èŠ‚ã€‚è¯·ä»¥æ€»ç»“ä¸å±•æœ›ä¸ºä¸»ï¼Œå‡ç»ƒå›é¡¾å…¨æ–‡ä¸»çº¿ï¼Œå¯¹æ–‡çŒ®è¿›è¡Œè¯„è¿°ï¼ŒæŒ‡å‡ºå…³é”®æ´è§ä¸å±€é™ï¼Œå½¢æˆæœ‰åŠ›åº¦çš„æ”¶æŸã€‚"

    start_task_hint = ""
    start_output_hint = ""
    if target_label == 'start':
        start_task_hint = "ã€èŒƒå›´çº¦æŸã€‘ä½ åªéœ€è¦æ’°å†™æ–‡çŒ®ç»¼è¿°çš„**å¼€ç¯‡/æ€»é¢†å°èŠ‚**ï¼ˆä½äºå…¨æ–‡ç¬¬ä¸€ä¸ªäºŒçº§æ ‡é¢˜ä¹‹å‰ï¼Œå…¶è¦æ±‚è¯·å‚ç…§å‰æ–‡è¯¦æƒ…ï¼‰ï¼Œæ¸…æ™°ä»‹ç»è¯¥é¢†åŸŸã€é˜è¿°æœ¬æ–‡çŒ®ç»¼è¿°å°†å¦‚ä½•æ¢³ç†è¯¥é¢†åŸŸçš„å‘å±•è„‰ç»œï¼›æ­¤ä»»åŠ¡å¹¶éæ’°å†™æ€»ç»“ã€å±•æœ›æˆ–ç»“è®ºç­‰ç»“å°¾å†…å®¹ã€‚"
        start_output_hint = "ã€æ–‡çŒ®å¼€ç¯‡ä¸“é¡¹è¦æ±‚ã€‘è¾“å‡ºå¿…é¡»ä»¥ '# ' ä¸€çº§æ ‡é¢˜å¼€å¤´ï¼ˆä¸å¸¦ç« èŠ‚ç¼–å·ï¼‰ã€‚"
    else:
        start_output_hint = "ã€æ³¨æ„ã€‘è¯·ä»¥â€œ## â€äºŒçº§æ ‡é¢˜+â€œn. â€æ•°å­—åºå·+â€œ...â€ç« èŠ‚åçš„æ ¼å¼å¼€å¤´ï¼Œä¾‹å¦‚â€œ## 1. æ ‡é¢˜â€ã€‚"
    # 2. æ„å»º Prompt
    prompt = f"""# ä¸Šä¸‹æ–‡èƒŒæ™¯
## æƒ…æ™¯è§’è‰²

ä½ æ˜¯ä¸€ä½**å­¦æœ¯ç»¼è¿°æ’°ç¨¿äºº**ï¼Œä½ å½“å‰çš„ä»»åŠ¡æ˜¯ï¼Œæ ¹æ®æ–‡çŒ®ç»¼è¿°çš„æ•´ä½“å¤§çº²èƒŒæ™¯ï¼Œè´Ÿè´£æ–‡çŒ®ç»¼è¿°ä¸­æŒ‡å®šå°èŠ‚çš„æ­£å¼æ’°å†™ã€‚

## æ–‡çŒ®ç»¼è¿°å…¨æ–‡èƒŒæ™¯ï¼ˆäº†è§£ä¸Šä¸‹æ–‡ï¼Œé¿å…åé¢˜ï¼‰

{outline_resp}

---
# ä»»åŠ¡ä¹¦

## ä½ æ‰€è´Ÿè´£çš„å°èŠ‚ä»¥åŠè¦æ±‚

{instruction}
{start_task_hint}

## ã€å†™ä½œè¦æ±‚ã€‘
- ä½ æ˜¯ä¸€ä½**å­¦æœ¯ç»¼è¿°æ’°ç¨¿äºº**ï¼Œä½ å½“å‰çš„ä»»åŠ¡æ˜¯ï¼Œæ ¹æ®æ–‡çŒ®ç»¼è¿°çš„æ•´ä½“å¤§çº²èƒŒæ™¯ï¼Œè´Ÿè´£æ–‡çŒ®ç»¼è¿°ä¸­æŒ‡å®šå°èŠ‚çš„æ­£å¼æ’°å†™ã€‚åœ¨æœ¬æ¬¡ä»»åŠ¡åˆ†å·¥ä¸­ï¼Œæ–‡çŒ®ç»¼è¿°çš„æ ¸å¿ƒå†…å®¹å·²ç”±å…¶ä»–åŒäº‹å®Œæˆï¼Œä½ æ‰€è´Ÿè´£çš„å°èŠ‚æ˜¯è¾¹ç¼˜ç« èŠ‚ï¼ˆå¦‚ä¸€ä¸ªç« èŠ‚çš„å¯¼å…¥ã€å…¨æ–‡çŒ®ç»¼è¿°çš„æ€»é¢†ã€å…¨æ–‡çŒ®ç»¼è¿°çš„æ€»ç»“ç­‰ç­‰ï¼‰ï¼Œè¿™äº›ç« èŠ‚åœ¨å…¨æ–‡å……å½“ç€å¥ å®šå…¨æ–‡ç»“æ„ä¸é€»è¾‘çº¿ç´¢çš„é‡è¦è§’è‰²ï¼Œå› æ­¤è™½è¯´å¹¶éæ ¸å¿ƒå†…å®¹ç« èŠ‚ï¼Œä½†å´åŒæ ·çš„é‡è¦ã€‚
- **é«˜å±‹å»ºç“´**ï¼šæ­¤éƒ¨åˆ†ä¸æ¶‰åŠå…·ä½“æ–‡çŒ®çš„å †ç Œï¼Œè€Œæ˜¯è¦æ¢³ç†è„‰ç»œã€é˜æ˜èƒŒæ™¯ã€å®šä¹‰é—®é¢˜æˆ–è¿›è¡Œæ€»ç»“ç‚¹è¯„ä¸å±•æœ›ç­‰ç­‰ï¼Œå› æ­¤åœ¨æ’°å†™æ—¶ï¼Œä½ éœ€è¦æ‰“å¼€æ ¼å±€ï¼Œé«˜å±‹å»ºç“´åœ°ç»„ç»‡è¯­è¨€ï¼Œç¡®ä¿é€»è¾‘æ¸…æ™°ã€‚
- ç²¾ç¡®ç†è§£â€œå­¦æœ¯æ•…äº‹æ€§â€çš„å†…æ¶µï¼Œå­¦æœ¯è®ºæ–‡ä¸­çš„â€œè®²æ•…äº‹â€å¹¶éä½¿ç”¨æ¯”å–»ç­‰ä¿®è¾æ‰‹æ³•ç»˜å£°ç»˜è‰²åœ°æè¿°ç ”ç©¶å†…å®¹ï¼Œæ–‡çŒ®ç»¼è¿°çš„è¯­è¨€é£æ ¼ä»æ—§éœ€è¦ä¿æŒä¸¥è°¨ä¸“ä¸šï¼Œå­¦æœ¯è®ºæ–‡ä¸­çš„â€œè®²æ•…äº‹â€æ˜¯æŒ‡åœ¨æ¢³ç†æ–‡çŒ®å‘å±•è„‰ç»œæ—¶ï¼Œæ¯ä¸ªç« èŠ‚æ¨¡å—é—´éƒ½æœ‰æ¸…æ™°çš„é€»è¾‘ä»¥åŠè¯­è¨€æ‰¿æ¥ï¼Œä¾‹å¦‚ç”±Aå‘å±•åˆ°Bï¼Œæˆ–è€…Cä¸Dä¹‹é—´å…·æœ‰å¯¹æ¯”ç­‰ç­‰ã€‚
- è¡Œæ–‡è§„èŒƒï¼š
    * **è¯­è¨€é£æ ¼**ï¼šç²¾ç‚¼ã€å®å¤§ã€æ·±åˆ»ã€å…·æœ‰æ´å¯ŸåŠ›ï¼›**å­¦æœ¯è¯­æ°”**ï¼Œä¿æŒå®¢è§‚ã€ä¸¥è°¨ã€é€»è¾‘æ€§å¼ºï¼Œé¿å…å£è¯­åŒ–ï¼›ä¸¥ç¦åœ¨æ­£æ–‡ä¸­ä½¿ç”¨â€œâ†’â€ç­‰ä¸ç¬¦åˆå­¦æœ¯è§„èŒƒçš„ç¬¦å·ï¼›ä¸¥ç¦åœ¨æ–‡ä¸­ä½¿ç”¨â€œæˆ‘â€ç­‰ä¸»è§‚è¯­è¨€ï¼Œè€Œè¦ä½¿ç”¨â€œæœ¬ç ”ç©¶â€ã€â€œæœ¬æ–‡â€ç­‰å®¢è§‚è¯­è¨€ã€‚
    * **è¡Œæ–‡é€»è¾‘**ï¼šå¦‚æœæ˜¯æ–‡çŒ®ç»¼è¿°å¼€ç¯‡ï¼Œè¦é«˜å±‹å»ºç“´ã€å¼•äººå…¥èƒœï¼Œå™è¿°å…·æœ‰â€œå­¦æœ¯æ•…äº‹æ„Ÿâ€ï¼›å¦‚æœæ˜¯äºŒçº§æ ‡é¢˜ä¸‹çš„æ€»é¢†æ¨¡å—ï¼Œè¦æ‰¿ä¸Šå¯ä¸‹ï¼Œæ¡ç†æ¸…æ™°ï¼›å¦‚æœæ˜¯æ–‡çŒ®ç»¼è¿°ç»“å°¾ç« èŠ‚ï¼Œè¦æ€»ç»“å…¨æ–‡ã€æ·±åˆ»æ´å¯Ÿã€å‡åä¸»é¢˜ã€‚
    * **é•¿åº¦è¦æ±‚**ï¼šå¦‚æœæ˜¯æ–‡çŒ®ç»¼è¿°å¼€ç¯‡ï¼Œå¯èŠ±700-1500å­—å·¦å³é˜è¿°æœ¬æ–‡çŒ®ç»¼è¿°çš„ç»“æ„ä¸é€»è¾‘æ€è·¯ï¼›å¦‚æœæ˜¯äºŒçº§æ ‡é¢˜ä¸‹çš„æ€»é¢†æ¨¡å—ï¼Œå¯èŠ±300-700å­—å·¦å³æ‰¿ä¸Šå¯ä¸‹ï¼Œæ¡¥æ¥æœ¬ç« èŠ‚ä¸æ•´ä¸ªæ–‡çŒ®ç»¼è¿°çš„é€»è¾‘è„‰ç»œå¹¶æ€»è¿°æœ¬ç« èŠ‚æ€è·¯é€»è¾‘ï¼›å¦‚æœæ˜¯æ–‡çŒ®ç»¼è¿°ç»“å°¾ç« èŠ‚ï¼Œå¯èŠ±500-1000å­—å·¦å³æ€»ç»“å…¨æ–‡å¹¶è¿›è¡Œç‚¹è¯„ä¸å±•æœ›ã€‚
    * **æ ‡é¢˜è¦æ±‚**ï¼šè‹¥æ˜¯äºŒçº§æ ‡é¢˜ä¸‹çš„æ€»é¢†æ¨¡å—æˆ–è€…ç»“å°¾ç« èŠ‚ï¼Œç”Ÿæˆæ—¶éœ€è¦è¿åŒæ ‡é¢˜ä»¥åŠåºå·ä¸€èµ·ç”Ÿæˆï¼Œå¦‚â€œ1. ...â€ã€â€œ4. ...â€ç­‰ï¼Œè‹¥æ˜¯æ–‡çŒ®ç»¼è¿°å¼€ç¯‡åˆ™ä¸å¿…å¸¦åºå·ï¼Œå¦‚â€œ# ...â€ã€‚
---

{start_output_hint}
è¯·å¼€å§‹æ’°å†™æ­£æ–‡ï¼š
"""
    try:
        api_key = os.environ.get('ARK_API_KEY', '')
        model_name = os.environ.get('ARK_MODEL', 'deepseek-v3-2-251201')
        print(f"[AI] æ­£åœ¨æ’°å†™ç« èŠ‚ {target_label} ...")
        return AI_call(prompt, api_key, model_name)
    except Exception as e:
        print(f"[Error] {target_label} æ’°å†™å¤±è´¥: {e}")
        return None


def gen_full_article_content(outline_dict, section_plans, main_info_dict, outline_resp):
    """
    å…¨ç¯‡ç»¼è¿°ç”Ÿæˆæ€»æ§å‡½æ•°ã€‚
    å¹¶è¡Œè°ƒç”¨å…·ä½“çš„ç”Ÿæˆå‡½æ•°ï¼Œæ±‡æ€»æ‰€æœ‰ç« èŠ‚çš„æ­£æ–‡ã€‚
    
    è¿”å›:
    - final_sections: dict, {label: æ­£æ–‡Markdown}
    """
    print(f"\n[Final Task] å¼€å§‹æ’°å†™å…¨ç¯‡æ–‡çŒ®ç»¼è¿° (å…± {len(outline_dict)} ä¸ªç« èŠ‚)...")
    
    final_sections = {}
    
    # å®šä¹‰æœ€å¤§å¹¶å‘æ•°
    MAX_WORKERS = 5
    
    with ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
        future_to_label = {}
        
        for label in outline_dict.keys():
            # åˆ¤æ–­ç« èŠ‚ç±»å‹
            # åŒ¹é… "æ•°å­—-æ•°å­—" æ ¼å¼ (å¦‚ 0-1, 12-3)
            if re.match(r'^\d+-\d+$', str(label)):
                # å…·ä½“å†…å®¹ç« èŠ‚ -> gen_content_section_text
                future = executor.submit(
                    gen_content_section_text, 
                    label, section_plans,outline_resp, outline_dict, main_info_dict
                )
            else:
                # å®è§‚/è¿‡æ¸¡ç« èŠ‚ (start, end, 0, 1...) -> gen_side_section_text
                future = executor.submit(
                    gen_side_section_text,
                    label, outline_dict, outline_resp
                )
            
            future_to_label[future] = label
            
        # æ”¶é›†ç»“æœ
        for future in as_completed(future_to_label):
            label = future_to_label[future]
            try:
                text = future.result()
                if text:
                    # --- 1. åˆæ­¥æ¸…æ´—ï¼šæå–æ­£æ–‡ ---
                    # æ£€æµ‹æ˜¯å¦å­˜åœ¨æ ‡é¢˜æ ·å¼ (#, ##, ### ç­‰)
                    header_match = re.search(r'(?m)^(#{1,6})\s', text)
                    if header_match:
                        # è‹¥å­˜åœ¨ï¼Œæå–ä»è¯¥æ ‡é¢˜å¼€å§‹çš„æ‰€æœ‰å†…å®¹
                        text = text[header_match.start():]
                    
                    # --- 2. æ ¼å¼è§„èŒƒåŒ– ---
                    target_level = 0
                    default_title = ""

                    if label == 'start':
                        target_level = 1
                        default_title = "æ–‡çŒ®ç»¼è¿°"
                    elif label == 'end':
                        target_level = 2
                        default_title = "æ–‡çŒ®æ€»ç»“ä¸å±•æœ›"
                    elif re.match(r'^\d+$', str(label)):
                        target_level = 2
                        default_title = "æœªæ£€å‡ºäºŒçº§æ ‡é¢˜"
                    elif re.match(r'^\d+-\d+$', str(label)):
                        target_level = 3
                        default_title = "æœªæ£€å‡ºä¸‰çº§æ ‡é¢˜"


                    if target_level > 0:
                        current_start_match = re.match(r'^(#{1,6})\s+(.*)', text)

                        def _strip_leading_number(s: str) -> str:
                            return re.sub(r'^\d+(?:\.\d+)*\s*[\.ã€]?\s*', '', (s or '').strip()).strip()

                        def _promote_numbered_line(body: str, level: int):
                            lines0 = (body or '').splitlines()
                            num = None
                            rest = None
                            idx0 = None

                            if level == 2:
                                for i2, ln in enumerate(lines0[:30]):
                                    m2 = re.match(r'^\s*(\d+)\s*[\.ã€]\s*(.+?)\s*$', ln)
                                    if m2:
                                        num = m2.group(1)
                                        rest = m2.group(2).strip()
                                        idx0 = i2
                                        break
                                if num is None:
                                    return None, body
                                title = f"{num}. {rest}" if rest else f"{num}."
                            elif level == 3:
                                for i3, ln in enumerate(lines0[:30]):
                                    m3 = re.match(r'^\s*(\d+(?:\.\d+)+)\s*[\.ã€]?\s*(.+?)\s*$', ln)
                                    if m3:
                                        num = m3.group(1)
                                        rest = m3.group(2).strip()
                                        idx0 = i3
                                        break
                                if num is None:
                                    return None, body
                                title = f"{num} {rest}".strip()
                            else:
                                return None, body

                            lines0.pop(idx0)
                            while idx0 < len(lines0) and lines0[idx0].strip() == "":
                                lines0.pop(idx0)
                            return title, "\n".join(lines0)

                        def _maybe_promote_placeholder(title_text: str, remainder: str, level: int, placeholder: str):
                            raw_title = (title_text or '').strip()
                            if raw_title == placeholder or _strip_leading_number(raw_title) == placeholder:
                                promoted, new_remainder = _promote_numbered_line(remainder, level)
                                if promoted:
                                    return promoted, new_remainder
                            return title_text, remainder

                        if current_start_match:
                            current_level = len(current_start_match.group(1))
                            title_text = current_start_match.group(2)
                            remainder = text[current_start_match.end():]

                            if label == 'start':
                                title_text = re.sub(r'^[\d\.]+\s*', '', (title_text or '')).strip()
                                if not title_text:
                                    title_text = default_title

                            if label == 'end':
                                if re.match(r'^\d+\.\d+', (title_text or '').strip()):
                                    title_text = re.sub(r'^[\d\.]+\s*', '', (title_text or '')).strip()

                            if re.match(r'^\d+$', str(label)):
                                title_text, remainder = _maybe_promote_placeholder(title_text, remainder, 2, default_title)
                                if not re.match(r'^\d+(\.\d+)*', (title_text or '').strip()):
                                    try:
                                        chap_num = int(label) + 1
                                        title_text = f"{chap_num}. {(title_text or '').strip()}".strip()
                                    except:
                                        pass

                            if re.match(r'^\d+-\d+$', str(label)):
                                title_text, remainder = _maybe_promote_placeholder(title_text, remainder, 3, default_title)

                            if current_level != target_level or title_text != current_start_match.group(2):
                                new_header = f"{'#' * target_level} {(title_text or '').strip()}"
                                text = new_header + remainder

                        else:
                            if re.match(r'^\d+$', str(label)):
                                promoted, body2 = _promote_numbered_line(text, 2)
                                if promoted:
                                    text = f"## {promoted}\n\n{body2}".strip()
                                else:
                                    text = f"## {default_title}\n\n{text}"
                            elif re.match(r'^\d+-\d+$', str(label)):
                                promoted, body3 = _promote_numbered_line(text, 3)
                                if promoted:
                                    text = f"### {promoted}\n\n{body3}".strip()
                                else:
                                    text = f"### {default_title}\n\n{text}"
                            else:
                                text = f"{'#' * target_level} {default_title}\n\n{text}"

                    final_sections[label] = text
                    print(f"  [æ’°å†™å®Œæˆ] {label}")
                else:
                    print(f"  [æ’°å†™å¤±è´¥] {label} è¿”å›ç©ºå†…å®¹")
            except Exception as exc:
                print(f"  [æ’°å†™å¼‚å¸¸] {label}: {exc}")
                
    return final_sections

def analyze_article_stats(text):
    """
    ç»Ÿè®¡æ–‡ç« çš„åŸºç¡€ä¿¡æ¯å¹¶æ‰“å°æŠ¥å‘Šã€‚
    """
    # å…¼å®¹å­—å…¸ç±»å‹çš„è¾“å…¥ (æ‹¼æ¥æ‰€æœ‰values)
    if isinstance(text, dict):
        text = "\n\n".join([str(val) for val in text.values()])

    if not text:
        print("[Stats] æ–‡ç« å†…å®¹ä¸ºç©ºã€‚")
        return

    # 1. æ€»å­—ç¬¦æ•° (å«ç©ºæ ¼æ¢è¡Œ)
    total_chars = len(text)
    
    # 2. æœ‰æ•ˆå­—æ•° (å»é™¤ç©ºç™½å­—ç¬¦)
    valid_chars = len(re.sub(r'\s', '', text))
    
    # 3. æ®µè½æ•°ä¼°è®¡ (æŒ‰åŒæ¢è¡Œç¬¦åˆ†å‰²)
    paragraphs = [p for p in text.split('\n\n') if p.strip()]
    num_paragraphs = len(paragraphs)
    
    print("\n" + "="*40)
    print(" ğŸ“Š æ–‡çŒ®ç»¼è¿°ç»Ÿè®¡æŠ¥å‘Š")
    print("="*40)
    print(f"  ğŸ“ æ€»å­—ç¬¦æ•°   : {total_chars:,}")
    print(f"  âœï¸ æœ‰æ•ˆå­—æ•°   : {valid_chars:,} (ä¸å«ç©ºç™½)")
    print(f"  Â¶  æ®µè½æ•°é‡   : {num_paragraphs}")
    print("="*40 + "\n")


if __name__ == "__main__":


    # é…ç½®æƒé‡
    weights_config_1 = {
        'main': 0.05,
        'summary': 0.2,
        'map': 0.55,
        'lineage': 0.2,
        'year': 0.0

    }
    weights_config_2 = {
        'main': 0.1,
        'summary': 0.2,
        'map': 0.4,
        'lineage': 0.2,
        'year': 0.1
    }

    keyword_section_weights_1 = {
                    'main': 0.1,
                    'summary': 0.2,    
                    'map': 0.35,
                    'lineage': 0.35
                }
    keyword_section_weights_2 = {
                    'main': 0.2,
                    'summary': 0.3,    
                    'map': 0.2,
                    'lineage': 0.3
                }

    folder_path = "C:\\æµ‹è¯•ç©ºæ–‡ä»¶å¤¹\\æ–‡çŒ®æ•´ç†åˆé›†"

    # ç¬¬ä¸€è½®ï¼šå…¨å±€èšç±»
    print("\n\n======== Round 1: Global Clustering ========")
    results1, anchor1, evaluation_text1, cluster_keywords_map1 = comprehensive_process_function(
        method='KMEANS', 
        weights_config_1=weights_config_1,
        keyword_section_weights=keyword_section_weights_1,
        folder_path=folder_path,
        n_components=20,
        k_penalty=0.02,
        similarity_threshold=0.75
    )


    # ç¬¬äºŒè½®ï¼šå¯¹æ¯ä¸ªå­ç±»è¿›è¡Œç»†åˆ†
    sub_results_storage = {} # å­˜å‚¨æ¯ä¸€è½®çš„ç»“æœ

    for label_id in labels_found:
        print(f"\n\n======== Round 2: Sub-clustering for Label {label_id} ========")
        try:
            # è°ƒç”¨ç¬¬äºŒè½®å¤„ç†å‡½æ•°
            # æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ä¼ å…¥ä¸Šä¸€è½®çš„ resultsï¼Œä»¥ä¾¿å‡½æ•°å†…éƒ¨ç­›é€‰å±äº label_id çš„æ–‡ç« 
            res2, anc2, eval2, kws2 = comprehensive_process_function(
                method='KMEANS', 
                weights_config_2=weights_config_2,
                keyword_section_weights=keyword_section_weights_2,
                label=label_id,       # æŒ‡å®šè¦ç»†åˆ†çš„çˆ¶ç±» ID
                results=results1,      # ä¼ å…¥ç¬¬ä¸€è½®çš„å®Œæ•´ç»“æœ
                n_components=20,
                k_penalty=0.01,
                similarity_threshold=0.75
            )
            
            sub_results_storage[label_id] = {
                'results': res2,
                'anchor': anc2,
                'evaluation': eval2,
                'keywords': kws2
            }
            

            
        except Exception as e:
            print(f"  [ERROR] Failed to process Label {label_id}: {e}")


    


    # è°ƒç”¨æ„é€ å‡½æ•°
    categories_dict, papers_dict = construct_swimlane_data(anchor1, cluster_keywords_map1, sub_results_storage)
    if papers_dict:
        plot_swimlane(categories_dict, papers_dict)



    outline_resp,outline_dict = gen_outline(anchor1, cluster_keywords_map1, sub_results_storage)
    print(outline_resp)

    

    # 1. æå–æœ¬åœ° Markdown æ–‡ä»¶çš„å†…å®¹å­—å…¸
    raw_docs_dict = extract_md_to_dict(folder_path)

    # 2. æ³¨å…¥æ ‡ç­¾
    main_info_dict = inject_labels_to_dict(raw_docs_dict, results1, sub_results_storage)

    section_plans = gen_all_section_plans(main_info_dict, outline_dict, outline_resp)
    
    full_article = gen_full_article_content(outline_dict, section_plans, main_info_dict, outline_resp)
    # ç»Ÿè®¡å¹¶æ‰“å°æ–‡ç« ä¿¡æ¯
    analyze_article_stats(full_article)